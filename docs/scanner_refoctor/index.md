# 扫描器重构

我们将完全重新设计扫描器，以提高效率和灵活性。可以借鉴当前扫描器的逻辑。例如

- 进度提示
- 错误处理
- 日志记录
- 性能优化
- 数据库小批量写入

## 扫描器设计

扫描将会被拆分为多个阶段：
- 初始扫描：负责遍历文件系统，发现元文件。负责解析元文件，提取元数据并保存到数据库中
- 完整扫描：根据数据库中的元数据信息和路径信息。遍历元数据文件同级别下的媒体文件（图片、视频等）。并存库做好相应的索引


### 初始扫描：仅扫描作品元数据文件.通过递归文件夹的方式 查找 {articalID}-meta.txt 文件。并且将文件内容解析为元数据对象。文件格式如下。

```json
// 131278560-meta.txt
ID
131278560

URL
https://www.pixiv.net/i/131278560

Original
https://i.pximg.net/img-original/img/2025/06/07/16/29/58/131278560_p0.png

Thumbnail
https://i.pximg.net/c/250x250_80_a2/img-master/img/2025/06/07/16/29/58/131278560_p0_square1200.jpg

xRestrict
R-18

AI
Yes

User
Aisey

UserID
102941617

Title
嗨♪ 想我了吗

Description


Tags
#AI生成
#R-18
#崩壊3rd
#崩坏星穹铁道
#爱莉希雅
#崩壊スターレイル
#Elysia
#cyrene
#昔涟
#キュレネ
#崩壊:スターレイル

Size
1160 x 1432

Bookmark
334

Date
2025-06-07T07:29:00+00:00


```

字段解析：

- ID：作品的唯一标识符
- URL：作品的URL
- Original：作品的原始图片URL
- Thumbnail：作品的缩略图URL
- xRestrict：作品的限制等级
- AI：是否为AI生成
- User：用户名
- UserID：用户的唯一标识符
- Title：作品的标题
- Description：作品的描述
- Tags：作品的标签，多个标签之间用空格分隔
- Size：作品的尺寸
- Bookmark：作品的收藏数量
- Date：作品的上传日期

除了 ID / User /UserID Title 这几个字段是必填的。其他字段都是可能为空的。做好判断校验


一个目录下可能存在多个作品元数据文件。 需要当成不同的作品进行保存。 保存时也需要保存 文件夹相对路径。 例如：

```
Artistname-Artistid/ArtworkTitle/131278560-meta.txt 
// Artistname 是艺术家名称
// Artistid 是艺术家ID
// ArtworkTitle 是作品标题
// 131278560 是作品ID
```

这样你可以辅助补充进数据库中

### 完整扫描

完整扫描会根据数据库中的元数据信息和路径信息。遍历元数据文件同级别下的媒体文件（图片、视频等）。并存库做好相应的索引。

需要注意的规则是。在上一步的元数据中有个固定的ID 字段。 而同级别下的媒体文件的文件名中也会包含这个ID。 例如：

```
131278560_p0.png
131278560_p10.jpg
```

这样我们就可以根据ID 来关联元数据和媒体文件。 

### 数据存储设计

数据存在数据库中 复用当前的数据库表结构： 艺术家表/作品表/标签表

值得注意他们的关联关系是

艺术家 对 多个作品 多对一
作品 对 多个标签 多对多

### 增量扫描

增量扫描为后续功能。我们先做假定设计。不做实现。你先参考需求做设计。给后续做冗余扩展做好准备

增量扫描只执行在初始扫描完成后。 增量扫描会根据数据库中的元数据信息和路径信息。如果元数据 作品id不存在 则走新增逻辑。如果id存在了就跳过。



## 总结

上面的是我的初步设计。请你综合考虑。是否有更好的设计以及不合理和疑问的地方。进行优化完善输出一份完整的重构方案文档




