# 作品图片全量替换功能实施计划 (V3)

## 1. 功能概述

实现作品图片的全量原子替换。采用 Busboy 流式上传，仅备份 `MEDIA_EXTENSIONS` 定义的媒体文件。上传过程中/完成后使用 Sharp 获取图片元数据，最终通过事务更新数据库。

## 2. 模块设计

### 2.1 后端 API (Pages Router)
**文件**: `src/pages/api/artwork/[id]/replace.ts`
**核心逻辑**:
1.  **配置**: 禁用 BodyParser。
2.  **备份**:
    *   引入 `MEDIA_EXTENSIONS` from `lib/constant`。
    *   遍历 `targetDir`，仅将后缀匹配 `MEDIA_EXTENSIONS` 的文件移动到 `.bak_{timestamp}`。
3.  **流式处理 (Busboy)**:
    *   接收文件流，写入 `targetDir`。
    *   **元数据提取**: 在文件写入完成后，立即调用 `sharp(filePath).metadata()` 获取 `width`, `height`, `size`。
    *   收集所有文件的元数据对象 `filesMeta`。
4.  **事务提交**:
    *   调用 `updateArtworkImagesTransaction(artworkId, filesMeta)`。
    *   成功: 异步清理备份。
    *   失败: 回滚文件（删除新文件，还原备份）。

### 2.2 Service 层
**文件**: `src/services/artwork-service/image-manager.ts`
**接口**:
```typescript
interface ImageMeta {
  fileName: string
  order: number
  width: number
  height: number
  size: number
}
updateArtworkImagesTransaction(artworkId: number, files: ImageMeta[])
```
**逻辑**:
1.  开启事务。
2.  删除旧 Image 记录。
3.  创建新 Image 记录 (使用传入的宽高大小)。
4.  更新 Artwork `imageCount` (不处理 `thumbnailUrl`)。

### 2.3 前端 UI
**文件**: `src/app/admin/artworks/_components/image-manager-dialog.tsx`
**逻辑**:
1.  使用 `STable` 展示现有列表。
2.  上传 Tab: 支持文件夹，前端正则提取 Order 并预览。
3.  上传请求: `POST /api/artwork/[id]/replace?path=...`，使用 FormData。

## 3. 实施步骤

### 步骤 1: Service 实现
创建 `src/services/artwork-service/image-manager.ts`，实现 DB 事务。

### 步骤 2: API 路由实现
创建 `src/pages/api/artwork/[id]/replace.ts`，实现 Busboy、备份、Sharp 元数据提取及回滚。

### 步骤 3: UI 组件
创建 `ImageManagerDialog`，集成到 `ArtworkManagement`。
