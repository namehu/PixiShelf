# 标签系统改造 - 对齐文档

## 项目上下文分析

### 现有项目架构
- **技术栈**: Next.js 14 + Prisma + PostgreSQL + TypeScript
- **部署环境**: Vercel (Serverless)
- **数据库**: PostgreSQL with pg_trgm extension (已启用)
- **认证系统**: 基于 session 的用户认证
- **UI框架**: Tailwind CSS + 自定义组件库

### 现有标签系统现状
1. **数据模型** (schema.prisma):
   ```prisma
   model Tag {
     id           Int          @id @default(autoincrement())
     name         String       @unique
     description  String?      // 已有描述字段
     artworkCount Int          @default(0) // 已有作品数量缓存
     createdAt    DateTime     @default(now())
     updatedAt    DateTime     @updatedAt
     artworkTags  ArtworkTag[]
     
     @@index([name])
     @@index([artworkCount], map: "Tag_artworkCount_idx")
   }
   ```

2. **现有API接口**:
   - `GET /api/tags/search` - 标签搜索 (支持 pg_trgm)
   - `GET /api/tags/popular` - 热门标签
   - `GET /api/tags/random` - 随机标签
   - `GET /api/tags/[id]` - 单个标签详情
   - `POST /api/tags/update-stats` - 手动更新统计

3. **现有管理界面**:
   - `/admin/setting` - 管理页面入口
   - `tag-management.tsx` - 基础标签统计管理组件

4. **现有类型定义**:
   - 完整的 TypeScript 类型系统
   - 标签相关类型在 `types/tags.ts` 中定义

## 需求理解确认

### 核心需求分析
基于 `tag_refactor.md` 设计文档，需要实现以下四个核心功能：

#### 1. 数据库结构扩展
- **目标**: 为 Tag 模型添加中文翻译支持
- **具体需求**:
  - 添加 `name_zh` 字段 (String?, 可选)
  - 添加 `search_vector` 字段支持全文搜索
  - 创建相应的索引和触发器
  - 保持向后兼容性

#### 2. 高性能双语搜索
- **目标**: 支持中英文统一搜索，搜索中文能找到英文标签
- **技术方案**: PostgreSQL Full-Text Search (FTS)
- **性能要求**: 毫秒级响应，支持大数据量

#### 3. 标签翻译管理界面
- **目标**: 提供可视化的标签翻译管理
- **功能需求**:
  - 标签列表展示 (分页)
  - 实时搜索过滤
  - 在线编辑中文翻译
  - 批量翻译触发
  - 翻译状态跟踪

#### 4. 自动批量翻译服务
- **目标**: 集成大模型API实现自动翻译
- **技术要求**:
  - 异步处理避免超时
  - 分批处理控制API调用频率
  - 错误处理和重试机制
  - 翻译质量保证

## 边界确认

### 功能边界
✅ **包含的功能**:
- 数据库 schema 修改和迁移
- 全文搜索索引和触发器
- 标签管理页面 UI
- 批量翻译 API 和服务
- 现有 API 的扩展和兼容

❌ **不包含的功能**:
- 用户权限管理 (复用现有管理员权限)
- 翻译历史记录
- 多语言支持 (仅支持中英文)
- 实时翻译进度推送

### 技术边界
- **数据库**: 仅修改 Tag 表，不影响其他表结构
- **API**: 扩展现有接口，保持向后兼容
- **前端**: 在现有管理页面基础上扩展
- **部署**: 适配 Vercel Serverless 环境限制

### 性能边界
- **搜索性能**: 支持 10万+ 标签的毫秒级搜索
- **翻译批次**: 单次处理 500 个标签以内
- **并发限制**: 考虑 LLM API 的速率限制

## 疑问澄清

### 1. 翻译服务选择
**问题**: 使用哪个大模型API服务？
**建议**: 
- OpenAI GPT-4 (质量高，成本适中)
- 或 Google Gemini (性价比好)
- 需要用户提供 API Key

### 2. 翻译策略
**问题**: 如何处理已有中文标签？
**策略**: 
- 检测标签语言，中文标签跳过翻译
- 提供手动覆盖选项

### 3. 数据迁移
**问题**: 现有数据如何处理？
**方案**:
- 平滑迁移，添加字段不影响现有功能
- 提供一键初始化脚本

### 4. 错误处理
**问题**: 翻译失败如何处理？
**策略**:
- 记录失败日志
- 提供重试机制
- 允许手动补充翻译

### 5. 缓存策略
**问题**: 搜索结果是否需要缓存？
**建议**: 
- 利用 PostgreSQL 内置缓存
- 考虑 Redis 缓存热门搜索

## 技术实现约束

### 1. Vercel 环境限制
- 函数执行时间限制 (10秒 Hobby, 60秒 Pro)
- 内存限制
- 冷启动考虑

### 2. 数据库约束
- 保持现有索引性能
- 迁移过程不能中断服务
- 备份策略

### 3. API 兼容性
- 现有 API 不能破坏性变更
- 新增字段向后兼容
- 错误处理一致性

## 验收标准

### 功能验收
1. ✅ 数据库成功添加 name_zh 字段和全文搜索支持
2. ✅ 中英文搜索功能正常，性能达标
3. ✅ 管理界面可以编辑和保存翻译
4. ✅ 批量翻译功能正常工作
5. ✅ 现有功能不受影响

### 性能验收
1. ✅ 搜索响应时间 < 100ms (10万标签)
2. ✅ 批量翻译不阻塞其他请求
3. ✅ 数据库迁移时间 < 5分钟

### 质量验收
1. ✅ 代码通过 TypeScript 检查
2. ✅ 遵循项目现有代码规范
3. ✅ 包含必要的错误处理
4. ✅ API 文档完整

## 风险评估

### 高风险项
1. **数据库迁移风险**: 大量数据迁移可能影响性能
   - 缓解: 分批迁移，非高峰期执行
2. **LLM API 成本**: 大量翻译请求成本较高
   - 缓解: 分批处理，提供成本预估

### 中风险项
1. **翻译质量**: 自动翻译可能不准确
   - 缓解: 提供手动编辑功能
2. **性能影响**: 新增字段和索引可能影响查询性能
   - 缓解: 充分测试，优化索引策略

### 低风险项
1. **UI 兼容性**: 新增管理界面可能与现有样式冲突
   - 缓解: 复用现有组件和样式

## 下一步行动

1. **确认技术选型**: LLM API 服务商和具体模型
2. **环境准备**: 确保开发和测试环境就绪
3. **开始架构设计**: 详细的技术架构和接口设计
4. **制定实施计划**: 分阶段实施策略和时间安排